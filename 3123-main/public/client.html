<!doctype html>
<html lang="uk">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <title>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</title>
        <script src="https://telegram.org/js/telegram-web-app.js"></script>
        <script>
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.expand();
                tg.headerColor = '#1a1a2e';
                tg.bottomBarColor = '#1a1a2e';
            }
        </script>
        <link rel="stylesheet" href="/style-enhancements.css">
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                color: #e0e0e0;
            }
            
            .app-container {
                width: 100%;
                max-width: 390px;
                background: rgba(30, 30, 45, 0.95);
                backdrop-filter: blur(20px);
                border-radius: 30px;
                padding: 30px 25px;
                padding-bottom: 80px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
                animation: slideInUp 0.4s ease-out;
            }
            
            @keyframes slideUp {
                from { opacity: 0; transform: translateY(30px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            h1 {
                font-size: 28px;
                font-weight: 700;
                text-align: center;
                margin-bottom: 25px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            
            .services-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                margin-bottom: 25px;
            }
            
            .service-card {
                background: #2a2a3e;
                border: 2.5px solid #3a3a4e;
                border-radius: 20px;
                padding: 20px 10px;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s;
                color: #e0e0e0;
            }
            
            .service-card.selected {
                border-color: #667eea;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            }
            
            .icon { font-size: 24px; display: block; margin-bottom: 8px; }
            .s-name { font-size: 15px; font-weight: 600; }
            
            input, textarea {
                width: 100%;
                padding: 16px 18px;
                margin-bottom: 12px;
                border: none;
                background: #2a2a3e;
                color: #e0e0e0;
                border-radius: 15px;
                font-size: 16px;
                font-family: inherit;
                outline: none;
                transition: all 0.3s;
            }
            
            textarea {
                resize: vertical;
                min-height: 60px;
            }
            
            input:focus, textarea:focus {
                background: #353550;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
            }
            
            .button-group {
                display: flex;
                gap: 10px;
            }
            
            .main-btn, .secondary-btn {
                flex: 1;
                padding: 18px;
                font-size: 17px;
                font-weight: 600;
                border: none;
                border-radius: 15px;
                cursor: pointer;
                transition: all 0.3s;
            }
            
            .main-btn {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: #ffffff;
                box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            }
            
            .secondary-btn {
                background: #2a2a3e;
                color: #667eea;
                border: 1px solid #3a3a4e;
            }
            
            .main-btn:active {
                transform: scale(0.98);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }
            
            .main-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }
            
            .status-section, .rating-section {
                display: none;
                text-align: center;
            }
            
            .status-icon {
                font-size: 40px;
                margin-bottom: 15px;
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }
            
            .status-text {
                font-size: 24px;
                font-weight: 700;
                margin-bottom: 15px;
                color: #e0e0e0;
            }
            
            .status-info {
                font-size: 14px;
                color: #b0b0b0;
                margin-bottom: 10px;
                background: #2a2a3e;
                padding: 15px;
                border-radius: 10px;
                line-height: 1.5;
            }
            
            .stars {
                font-size: 32px;
                margin: 15px 0;
                letter-spacing: 8px;
            }
            
            .star {
                cursor: pointer;
                opacity: 0.3;
                transition: opacity 0.2s;
            }
            
            .star.active, .star:hover {
                opacity: 1;
            }
            
        </style>
    </head>
    <body>
        <div class="app-container" id="form-container">
            <h1>üõ† –û–±–µ—Ä—ñ—Ç—å –ø–æ—Å–ª—É–≥—É</h1>
            <div class="services-grid">
                <div class="service-card selected" onclick="selectService(this, '–¢–∞–∫—Å—ñ üöï')">
                    <span class="icon">üöñ</span>
                    <span class="s-name">–¢–∞–∫—Å—ñ</span>
                </div>
                <div class="service-card" onclick="selectService(this, '–í–∞–Ω—Ç–∞–∂–Ω–∏–π üöö')">
                    <span class="icon">üöö</span>
                    <span class="s-name">–í–∞–Ω—Ç–∞–∂</span>
                </div>
                <div class="service-card" onclick="selectService(this, '–ö—É—Ä\'—î—Ä üì¶')">
                    <span class="icon">üì¶</span>
                    <span class="s-name">–ö—É—Ä'—î—Ä</span>
                </div>
                <div class="service-card" onclick="selectService(this, '–ë—É–∫—Å–∏—Ä ü™ù')">
                    <span class="icon">ü™ù</span>
                    <span class="s-name">–ë—É–∫—Å–∏—Ä</span>
                </div>
            </div>
            
            <input type="text" id="from" placeholder="–ó–≤—ñ–¥–∫–∏?" />
            <input type="text" id="to" placeholder="–ö—É–¥–∏?" />
            <div style="margin-bottom: 10px;">
                <label id="comment-label" style="font-size: 12px; color: #b0b0b0; display: block; margin-bottom: 5px;">üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <textarea id="comment" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä" style="width: 100%; padding: 12px; border: 1px solid #3a3a4e; border-radius: 10px; background: #2a2a3e; color: #e0e0e0; font-size: 16px; margin-bottom: 10px; font-family: inherit; resize: vertical; min-height: 60px;"></textarea>
            </div>
            
            <div class="button-group">
                <button class="main-btn" id="btn" onclick="sendOrder()">–ó–∞–º–æ–≤–∏—Ç–∏</button>
                <button class="secondary-btn" onclick="cancelCurrentOrder()" id="cancel-btn" style="display:none;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>

        <div class="app-container status-section" id="status">
            <div class="status-icon">‚è≥</div>
            <h3 class="status-text">–®—É–∫–∞—î–º–æ –≤–∏–∫–æ–Ω–∞–≤—Ü—è...</h3>
            <div class="status-info">
                üìç –í—ñ–¥: <b id="from-display"></b><br>
                üèÅ –î–æ: <b id="to-display"></b>
            </div>
            <button class="secondary-btn" onclick="cancelCurrentOrder()">–°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
        </div>

        <!-- –ü–†–û–ü–û–ó–ò–¶–Ü–Ø –¶–Ü–ù–ò –í–Ü–î –í–û–î–Ü–Ø -->
        <div class="app-container status-section" id="price-offer" style="display:none;">
            <div class="status-icon">üí∞</div>
            <h3 class="status-text">–í–æ–¥—ñ–π –∑–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞–≤ —Ü—ñ–Ω—É!</h3>
            
            <!-- –ü–†–û–§–Ü–õ–¨ –í–û–î–Ü–Ø -->
            <div id="driver-profile-price" style="background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 15px; padding: 20px; margin-bottom: 15px; color: white; animation: slideInUp 0.3s ease-out;">
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div id="driver-avatar-price" style="width: 70px; height: 70px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 35px; flex-shrink: 0;">üë§</div>
                    <div style="flex: 1;">
                        <div id="driver-name-price" style="font-size: 18px; font-weight: 700; margin-bottom: 5px;">–í–æ–¥—ñ–π</div>
                        <div id="driver-rating-price" style="font-size: 14px; opacity: 0.9;">‚≠ê 4.8 —Ä–µ–π—Ç–∏–Ω–≥</div>
                    </div>
                </div>
            </div>
            
            <!-- –¶–Ü–ù–ê -->
            <div style="background: linear-gradient(135deg, #34c759, #30d158); padding: 30px; border-radius: 20px; margin-bottom: 15px; text-align: center; box-shadow: 0 10px 30px rgba(52, 199, 89, 0.3);">
                <div style="font-size: 14px; color: white; margin-bottom: 12px; font-weight: 600;">üíµ –ó–ê–ü–†–û–ü–û–ù–û–í–ê–ù–ê –¶–Ü–ù–ê</div>
                <div style="font-size: 56px; font-weight: 700; color: white;" id="offered-price">0 –≥—Ä–Ω</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="secondary-btn" onclick="rejectPrice()" style="background: #ff3b30; color: white;">‚ùå –ù–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å</button>
                <button class="main-btn" onclick="acceptPrice()" style="background: #34c759; color: white;">‚úÖ –ü—ñ–¥—Ö–æ–¥–∏—Ç—å</button>
            </div>
        </div>

        <div class="app-container status-section" id="accepted">
            <div class="status-icon">‚úÖ</div>
            <h3 class="status-text">‚úÖ –í–æ–¥—ñ–π –ø—Ä–∏–π–Ω—è–≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è!</h3>
            
            <!-- –ü–†–û–§–Ü–õ–¨ –í–û–î–Ü–Ø -->
            <div id="driver-profile" style="background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 15px; padding: 20px; margin-bottom: 15px; color: white; animation: slideInUp 0.3s ease-out;">
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div id="driver-avatar" style="width: 70px; height: 70px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 35px; flex-shrink: 0;">üë§</div>
                    <div style="flex: 1;">
                        <div id="driver-name" style="font-size: 18px; font-weight: 700; margin-bottom: 5px;">–í–æ–¥—ñ–π</div>
                        <div id="driver-rating" style="font-size: 14px; opacity: 0.9;">‚≠ê 4.8 —Ä–µ–π—Ç–∏–Ω–≥</div>
                        <div id="driver-phone" style="font-size: 12px; opacity: 0.8; margin-top: 5px;">üì± +38 0XX XXX XX XX</div>
                    </div>
                </div>
            </div>


            <!-- –®–í–ò–î–ö–Ü –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0;">
                <button class="secondary-btn" onclick="sendQuickMessage('–î–µ –≤–∏ –∑–∞—Ä–∞–∑?')" style="padding: 12px; font-size: 13px;">üìç –î–µ –≤–∏?</button>
                <button class="secondary-btn" onclick="sendQuickMessage('–Ø –ø–æ—Å–ø—ñ—à–∞—é!')" style="padding: 12px; font-size: 13px;">‚è∞ –ü–æ—Å–ø—ñ—à–∞—é</button>
            </div>

            <div id="chat-client" style="display:none; margin: 15px 0; background: white; border-radius: 15px; padding: 15px;">
                <div id="chat-messages-client" style="height: 150px; overflow-y: auto; margin-bottom: 10px; background: #f5f5f7; border-radius: 10px; padding: 10px;"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="message-input-client" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="flex: 1; padding: 10px; border: 1px solid #e5e5ea; border-radius: 10px;">
                    <button class="main-btn" onclick="sendClientMessage()" style="width: 100px; padding: 10px; margin: 0;">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
                </div>
            </div>
            <button class="main-btn" onclick="toggleClientChat()">üí¨ –ß–∞—Ç –∑ –≤–∏–∫–æ–Ω–∞–≤—Ü–µ–º</button>
        </div>

        <div class="app-container rating-section" id="rating">
            <h3 class="status-text">–û—Ü—ñ–Ω—ñ—Ç—å –ø–æ—Å–ª—É–≥—É</h3>
            <div class="stars" id="stars" style="cursor: pointer;"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="main-btn" onclick="submitRating()" style="flex: 1;">‚≠ê –ü–æ—Å—Ç–∞–≤–∏—Ç–∏ –æ—Ü—ñ–Ω–∫—É</button>
                <button class="secondary-btn" onclick="closeRating()" style="flex: 1;">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>

        <!-- –Ü–°–¢–û–†–Ü–Ø –ó–ê–ú–û–í–õ–ï–ù–¨ -->
        <div class="app-container" id="history" style="display: none;">
            <h2 style="color: #e0e0e0; margin-bottom: 20px;">üìú –Ü—Å—Ç–æ—Ä—ñ—è –∑–∞–º–æ–≤–ª–µ–Ω—å</h2>
            <div id="history-list" style="max-height: 500px; overflow-y: auto;"></div>
            <button class="secondary-btn" onclick="showForm()" style="width: 100%; margin-top: 15px;">–ù–∞–∑–∞–¥</button>
        </div>

        <div class="bottom-nav" id="bottom-nav" style="display: none;">
            <div class="bottom-nav-item active" onclick="showForm()">üìã –ó–∞–º–æ–≤–∏—Ç–∏</div>
            <div class="bottom-nav-item" onclick="loadAndShowHistory()">üìú –Ü—Å—Ç–æ—Ä—ñ—è</div>
            <div class="bottom-nav-item" onclick="toggleTheme()">üåô –¢–µ–º–∞</div>
        </div>

        <script>
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();

            let selectedType = "–¢–∞–∫—Å—ñ üöï";
            let currentOrderId = null;
            let driverArrivedSoundPlayed = false;
            let selectedStars = 0;
            const soundDriverArrived = new Audio("alert.mp3");
            
            function acceptPrice() {
                fetch("/accept-driver-price", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ orderId: currentOrderId })
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        document.getElementById("price-offer").style.display = "none";
                        document.getElementById("accepted").style.display = "block";
                        // –¢–∞–π–º–µ—Ä –ù–ï —Å—Ç–∞—Ä—Ç—É—î - —Ç—ñ–ª—å–∫–∏ –∫–æ–ª–∏ –≤–æ–¥—ñ–π –ø—Ä–∏—ó—Ö–∞–≤!
                    }
                });
            }
            
            function rejectPrice() {
                fetch("/reject-driver-price", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ orderId: currentOrderId })
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        document.getElementById("price-offer").style.display = "none";
                        document.getElementById("accepted").style.display = "none";
                        document.getElementById("status").style.display = "block";
                        document.getElementById("form-container").style.display = "none";
                    }
                });
            }
            let rideStartTime = null;
            let timerInterval = null;
            
            // LIVE TIMER (–í–ò–î–ê–õ–ï–ù–û)
            function startRideTimer() {
                // –¢–∞–π–º–µ—Ä –≤–∏–¥–∞–ª–µ–Ω–æ –∑–∞ –∑–∞–ø–∏—Ç–æ–º
            }

            // –®–í–ò–î–ö–Ü –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø
            window.sendQuickMessage = (msg) => {
                if (!currentOrderId) return;
                const input = document.getElementById("message-input-client");
                input.value = msg;
                sendClientMessage();
            };

            // AUTO-POLL –°–¢–ê–¢–£–°–£ –ë–ï–ó –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ò
            function pollOrderStatus() {
                if (!currentOrderId) return;
                fetch(`/get-order/${currentOrderId}`)
                    .then(r => r.json())
                    .then(order => {
                        if (!order) return;
                        
                        // –û–î–ù–û–†–ê–ó–û–í–ò–ô –ó–í–£–ö –ö–û–õ–ò –í–û–î–Ü–ô –ù–ê –ú–Ü–°–¶–Ü
                        if (order.status === 'driver_arrived' && !driverArrivedSoundPlayed) {
                            soundDriverArrived.play().catch(() => {});
                            driverArrivedSoundPlayed = true;
                        }
                        
                        if (order.status === 'completed') {
                            document.getElementById("accepted").style.display = "none";
                            document.getElementById("chat-client").style.display = "none";
                            document.getElementById("chat-messages-client").innerHTML = '';
                            document.getElementById("rating").style.display = "flex";
                            if (timerInterval) clearInterval(timerInterval);
                            if (pollingInterval) clearInterval(pollingInterval);
                        }
                    })
                    .catch(() => {});
            }

            function getUniqueUserId() {
                if (tg.initDataUnsafe?.user?.id) return tg.initDataUnsafe.user.id;
                let testUserId = localStorage.getItem('test_client_user_id');
                if (!testUserId) {
                    testUserId = Math.floor(Math.random() * 900000000) + 100000000;
                    localStorage.setItem('test_client_user_id', testUserId);
                }
                return parseInt(testUserId);
            }
            
            const userId = getUniqueUserId();

            // LIVE POLLING –∫–æ–∂–Ω—ñ 3.5 —Å–µ–∫—É–Ω–¥–∏ (–û–ü–¢–ò–ú–Ü–ó–û–í–ê–ù–û: –º–µ–Ω—à–µ –∑–∞–ø–∏—Ç—ñ–≤)
            setInterval(pollOrderStatus, 3500);
            let pollingInterval = null;

            function toggleClientChat() {
                document.getElementById("chat-client").style.display = document.getElementById("chat-client").style.display === "none" ? "block" : "none";
                loadClientMessages();
            }

            function sendClientMessage() {
                const msg = document.getElementById("message-input-client").value.trim();
                if (!msg || !currentOrderId) return;
                fetch("/send-message", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ orderId: currentOrderId, senderId: userId, message: msg })
                }).then(() => {
                    document.getElementById("message-input-client").value = "";
                    loadClientMessages();
                });
            }

            function loadClientMessages() {
                if (!currentOrderId) return;
                fetch(`/messages/${currentOrderId}`).then(r => r.json()).then(msgs => {
                    const chat = document.getElementById("chat-messages-client");
                    if (msgs.length === 0) {
                        chat.innerHTML = '<div style="color: #b0b0b0; text-align: center; padding: 20px;">üí¨ –ß–∞—Ç –æ—á–∏—â–µ–Ω–∏–π</div>';
                    } else {
                        chat.innerHTML = msgs.map(m => `<div style="margin: 5px 0; padding: 8px; background: ${m.senderId == userId ? '#34c759' : '#007aff'}; color: white; border-radius: 8px; margin-left: ${m.senderId == userId ? '40px' : '0'}; margin-right: ${m.senderId == userId ? '0' : '40px'};">${m.message}</div>`).join("");
                        chat.scrollTop = chat.scrollHeight;
                    }
                });
            }

            function loadNotifications() {
                // Notifications –≤–∏–¥–∞–ª–µ–Ω–æ
            }

            if (userId) {
                fetch(`/current-order/${userId}`)
                    .then(r => r.json())
                    .then(state => {
                        if (state.found) {
                            document.getElementById("form-container").style.display = "none";
                            if (state.order.status === 'accepted' || state.order.status === 'driver_arrived') {
                                document.getElementById("accepted").style.display = "block";
                                currentOrderId = state.order.id;
                            } else {
                                document.getElementById("status").style.display = "block";
                                document.getElementById("from-display").textContent = state.order.fromAddress;
                                document.getElementById("to-display").textContent = state.order.toAddress;
                                currentOrderId = state.order.id;
                                startPolling(state.order.id);
                            }
                        }
                    });
            }

            function selectService(el, type) {
                document.querySelectorAll(".service-card").forEach(c => c.classList.remove("selected"));
                el.classList.add("selected");
                selectedType = type;
                
                // –î–∏–Ω–∞–º—ñ—á–Ω—ñ –ø–æ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç–∏–ø—É –ø–æ—Å–ª—É–≥–∏
                const commentField = document.getElementById('comment');
                const labelEl = document.getElementById('comment-label');
                const btnEl = document.getElementById('btn');
                
                if (type.includes('–í–∞–Ω—Ç–∞–∂–Ω–∏–π')) {
                    labelEl.textContent = 'üì¶ –©–æ —Å–∞–º–µ —Ç—Ä–µ–±–∞ –ø–µ—Ä–µ–≤–µ–∑—Ç–∏? (–æ–±–æ–≤\'—è–∑–∫–æ–≤–æ)';
                    commentField.placeholder = '–û–ø–∏—à—ñ—Ç—å –≤–∞–Ω—Ç–∞–∂ (–ø—ñ—Å–æ–∫, –º–µ–±–ª—ñ, –∫–æ—Ä–æ–±–∫–∏ —Ç–æ—â–æ)';
                    commentField.required = true;
                } else if (type.includes('–ö—É—Ä\'—î—Ä')) {
                    labelEl.textContent = 'üì¶ –©–æ —Ç—Ä–µ–±–∞ –ø–µ—Ä–µ–≤–µ–∑—Ç–∏? (–æ–±–æ–≤\'—è–∑–∫–æ–≤–æ)';
                    commentField.placeholder = '–û–ø–∏—à—ñ—Ç—å –ø–æ—Å–∏–ª–∫—É (–¥–æ–∫—É–º–µ–Ω—Ç–∏, –ø–æ—Å–∏–ª–∫–∞, –∫–Ω–∏–≥–∏ —Ç–æ—â–æ)';
                    commentField.required = true;
                } else if (type.includes('–ë—É–∫—Å–∏—Ä')) {
                    labelEl.textContent = 'üöó –©–æ –∑–∞ –∞–≤—Ç–æ? (–æ–±–æ–≤\'—è–∑–∫–æ–≤–æ)';
                    commentField.placeholder = '–ú–∞—Ä–∫–∞ –π –º–æ–¥–µ–ª—å –∞–≤—Ç–æ (BMW X5, Toyota Camry —Ç–æ—â–æ)';
                    commentField.required = true;
                } else {
                    labelEl.textContent = 'üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä (–Ω–µ–æ–±–æ–≤\'—è–∑–∫–æ–≤–æ)';
                    commentField.placeholder = '–ö–æ–º–µ–Ω—Ç–∞—Ä';
                    commentField.required = false;
                }
                
                commentField.value = '';
                if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
            }

            function sendOrder() {
                const from = document.getElementById("from").value.trim();
                const to = document.getElementById("to").value.trim();
                const comment = document.getElementById("comment").value.trim();

                if (!from || !to) return tg.showAlert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –∞–¥—Ä–µ—Å–∏!");
                
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö –ø–æ–ª—ñ–≤ –¥–ª—è –¥–µ—è–∫–∏—Ö –ø–æ—Å–ª—É–≥
                if ((selectedType.includes('–í–∞–Ω—Ç–∞–∂–Ω–∏–π') || selectedType.includes('–ö—É—Ä\'—î—Ä') || selectedType.includes('–ë—É–∫—Å–∏—Ä')) && !comment) {
                    return tg.showAlert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤\'—è–∑–∫–æ–≤–µ –ø–æ–ª–µ!");
                }

                document.getElementById("btn").disabled = true;
                document.getElementById("btn").innerText = "–ó–∞—á–µ–∫–∞–π—Ç–µ...";

                fetch("/order", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        userId, fromAddress: from, toAddress: to,
                        serviceType: selectedType, comment
                    }),
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.error) return tg.showAlert(data.error);
                        currentOrderId = data.orderId;
                        document.getElementById("form-container").style.display = "none";
                        document.getElementById("status").style.display = "block";
                        document.getElementById("from-display").textContent = from;
                        document.getElementById("to-display").textContent = to;
                        startPolling(data.orderId);
                    })
                    .catch(e => tg.showAlert("–ü–æ–º–∏–ª–∫–∞: " + e.message));
            }

            function startPolling(orderId) {
                if (pollingInterval) clearInterval(pollingInterval);
                pollingInterval = setInterval(() => {
                    fetch(`/check-order/${orderId}`)
                        .then(r => r.json())
                        .then(res => {
                            if (res.status === "price_offered") {
                                const order = res.order;
                                const driver = res.driverName || '–í–æ–¥—ñ–π';
                                document.getElementById("status").style.display = "none";
                                document.getElementById("price-offer").style.display = "block";
                                document.getElementById("offered-price").textContent = order.driverPrice + ' –≥—Ä–Ω';
                                document.getElementById("driver-name-price").textContent = driver;
                                document.getElementById("driver-rating-price").textContent = '‚≠ê ' + (res.driverRating || '4.8') + ' —Ä–µ–π—Ç–∏–Ω–≥';
                                currentOrderId = orderId;
                                // –í–ò–ü–†–ê–í–õ–ï–ù–û: –ù–ï –ø—Ä–∏–ø–∏–Ω—è—î–º–æ polling,Á∂ôÁª≠–ø—Ä–æ–≤–µ—Ä—è—Ç–∏ —Å—Ç–∞—Ç—É—Å!
                            } else if (res.status === "accepted") {
                                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred("success");
                                document.getElementById("status").style.display = "none";
                                document.getElementById("price-offer").style.display = "none";
                                document.getElementById("accepted").style.display = "block";
                                startRideTimer();
                                loadNotifications();
                                loadClientMessages();
                                // –í–ò–ü–†–ê–í–õ–ï–ù–û: –ó–∞–ø—É—Å–∫–∞—î–º–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —á–∞—Ç—É –∫–æ–∂–Ω—ñ 1.5 —Å–µ–∫
                                setInterval(loadClientMessages, 1500);
                            } else if (res.status === "not_found") {
                                clearInterval(pollingInterval);
                                tg.showAlert("–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ");
                                location.reload();
                            } else if (res.status === "completed") {
                                clearInterval(pollingInterval);
                                showRating(orderId);
                            }
                        });
                }, 2000);
            }

            function cancelCurrentOrder() {
                if (!confirm("–°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?")) return;
                fetch("/cancel-order", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ orderId: currentOrderId })
                }).then(() => location.reload());
            }

            function showRating(orderId) {
                currentOrderId = orderId;
                document.getElementById("status").style.display = "none";
                document.getElementById("accepted").style.display = "none";
                document.getElementById("rating").style.display = "block";
                
                const ratings = [
                    { stars: 1, label: 'üòû –ü–æ–≥–∞–Ω–æ', emoji: '1Ô∏è‚É£' },
                    { stars: 2, label: 'üòï –¢–∞–∫ —Å–æ–±—ñ', emoji: '2Ô∏è‚É£' },
                    { stars: 3, label: 'üòê –ù–æ—Ä–º–∞–ª—å–Ω–æ', emoji: '3Ô∏è‚É£' },
                    { stars: 4, label: 'üòä –î–æ–±—Ä–µ', emoji: '4Ô∏è‚É£' },
                    { stars: 5, label: 'üòç –í—ñ–¥–º—ñ–Ω–Ω–æ!', emoji: '5Ô∏è‚É£' }
                ];
                
                let stars = '';
                ratings.forEach((r, idx) => {
                    stars += `<div class="star" data-stars="${r.stars}" style="display:inline-block; margin:5px; cursor:pointer; text-align:center; transition:all 0.3s;" onclick="setRating(${r.stars})" data-index="${idx}"><div style="font-size:32px; margin-bottom:5px;">‚≠ê</div><div style="font-size:11px; color:#b0b0b0;">${r.label}</div></div>`;
                });
                document.getElementById("stars").innerHTML = stars;
            }

            window.setRating = (num) => {
                selectedStars = num;
                const starElements = document.querySelectorAll(".star");
                starElements.forEach((s, i) => {
                    if (i < num) {
                        s.style.opacity = "1";
                        s.style.transform = "scale(1.1)";
                    } else {
                        s.style.opacity = "0.5";
                        s.style.transform = "scale(1)";
                    }
                });
            };

            function toggleTheme() {
                document.body.classList.toggle("light-theme");
                localStorage.setItem("theme", document.body.classList.contains("light-theme") ? "light" : "dark");
            }

            function showForm() {
                document.getElementById("form-container").style.display = "flex";
                document.getElementById("status").style.display = "none";
                document.getElementById("accepted").style.display = "none";
                document.getElementById("rating").style.display = "none";
            }

            // –Ü–°–¢–û–†–Ü–Ø –ó–ê–ú–û–í–õ–ï–ù–¨
            async function loadAndShowHistory() {
                document.getElementById("form-container").style.display = "none";
                document.getElementById("status").style.display = "none";
                document.getElementById("accepted").style.display = "none";
                document.getElementById("rating").style.display = "none";
                document.getElementById("history").style.display = "block";
                
                const res = await fetch(`/user-orders/${userId}`);
                const orders = await res.json();
                
                const historyDiv = document.getElementById("history-list");
                if (orders.length === 0) {
                    historyDiv.innerHTML = '<div style="color: #b0b0b0; text-align: center; padding: 40px;">üì≠ –ù–µ–º–∞—î –∑–∞–º–æ–≤–ª–µ–Ω—å</div>';
                } else {
                    historyDiv.innerHTML = orders.map(o => `
                        <div style="background: #2a2a3e; border-radius: 12px; padding: 15px; margin-bottom: 12px; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #667eea; font-weight: 600;">üìç ${o.fromAddress}</span>
                                <span style="font-size: 12px; color: #b0b0b0;">${new Date(o.createdAt).toLocaleDateString('uk-UA')}</span>
                            </div>
                            <div style="color: #b0b0b0; font-size: 14px; margin-bottom: 8px;">üèÅ ${o.toAddress}</div>
                            <div style="display: flex; gap: 10px; justify-content: space-between; font-size: 13px;">
                                <span style="color: #34c759;">‚úÖ ${o.status === 'completed' ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–í –ø—Ä–æ—Ü–µ—Å—ñ'}</span>
                                <span style="color: #667eea;">üíµ ${o.price || 'TBD'} –≥—Ä–Ω</span>
                                ${o.rating ? `<span style="color: #ffb800;">‚≠ê ${o.rating}</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            }

            // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—É —Ç–µ–º—É
            if (localStorage.getItem("theme") === "light") {
                document.body.classList.add("light-theme");
            }

            window.submitRating = () => {
                if (selectedStars === 0) {
                    alert("–í–∏–±–µ—Ä—ñ—Ç—å –æ—Ü—ñ–Ω–∫—É!");
                    return;
                }
                fetch("/rate-order", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ orderId: parseInt(currentOrderId), stars: parseInt(selectedStars) })
                }).then(r => {
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                }).then(data => {
                    alert("‚úÖ –î—è–∫—É—î–º–æ –∑–∞ –æ—Ü—ñ–Ω–∫—É!");
                    location.reload();
                }).catch(e => {
                    console.error("–ü–æ–º–∏–ª–∫–∞ –æ—Ü—ñ–Ω–∫–∏:", e.message);
                    alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –æ—Ü—ñ–Ω–∫–∏");
                });
            };

            window.closeRating = () => {
                location.reload();
            };
        </script>
    </body>
</html>
